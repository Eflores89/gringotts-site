<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gringotts</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="page-header">
    <div class="container">
      <h1>Gringotts</h1>
      <div class="nav-links">
        <a href="index.html">Dashboard</a>
        <a href="add-cash.html">Add Cash</a>
        <a href="clean-spending.html">Clean Spending</a>
        <a href="review.html">Review</a>
        <a href="investments.html" class="active">Investments</a>
        <a href="#" id="logout-btn">Logout</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- FX Rate Filters -->
    <div class="filters">
      <div class="form-group">
        <label for="fx-usd">USD/EUR</label>
        <input type="number" id="fx-usd" step="0.001" min="0.01" placeholder="0.92">
      </div>
      <div class="form-group">
        <label for="fx-gbp">GBP/EUR</label>
        <input type="number" id="fx-gbp" step="0.001" min="0.01" placeholder="1.17">
      </div>
      <div class="form-group">
        <label for="fx-mxn">MXN/EUR</label>
        <input type="number" id="fx-mxn" step="0.0001" min="0.001" placeholder="0.054">
      </div>
      <div class="form-group">
        <label>&nbsp;</label>
        <button id="apply-fx" class="btn btn-primary">Apply</button>
      </div>
      <div class="form-group" style="margin-left: auto;">
        <label>&nbsp;</label>
        <button id="refresh-prices" class="btn btn-secondary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Refresh Prices
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="card hidden">
      <div style="text-align: center; padding: 40px;">
        <div class="spinner spinner-dark" style="width: 40px; height: 40px;"></div>
        <p style="margin-top: 15px; color: var(--text-light);">Loading investments...</p>
      </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="hidden"></div>

    <!-- Summary Stats -->
    <div id="stats-container" class="stats-grid hidden">
      <div class="stat-card">
        <div class="label">Total Portfolio Value</div>
        <div class="value" id="stat-total-value">--</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Gain / Loss</div>
        <div class="value" id="stat-gain-loss">--</div>
        <div class="change" id="stat-gain-loss-pct"></div>
      </div>
      <div class="stat-card">
        <div class="label">Liquid Value</div>
        <div class="value" id="stat-liquid">--</div>
      </div>
      <div class="stat-card">
        <div class="label">Unvested Value</div>
        <div class="value" id="stat-unvested">--</div>
      </div>
    </div>

    <!-- Portfolio Holdings Table -->
    <div id="portfolio-section" class="card hidden">
      <h2 class="card-title">Portfolio Holdings</h2>
      <div class="table-container">
        <table id="portfolio-table">
          <thead>
            <tr>
              <th>Asset</th>
              <th>Type</th>
              <th style="text-align: right;">Qty</th>
              <th style="text-align: right;">Current Value (EUR)</th>
              <th style="text-align: right;">Gain / Loss</th>
              <th style="text-align: right;">Return</th>
              <th style="text-align: right;">% Portfolio</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="portfolio-table-body">
          </tbody>
          <tfoot>
            <tr style="font-weight: bold;">
              <td>TOTAL</td>
              <td></td>
              <td></td>
              <td style="text-align: right;" id="total-value">--</td>
              <td style="text-align: right;" id="total-gain-loss">--</td>
              <td style="text-align: right;" id="total-return">--</td>
              <td style="text-align: right;">100%</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Charts Section -->
    <div id="charts-section" class="hidden">
      <!-- Gain/Loss + Asset Type row -->
      <div class="chart-grid">
        <div class="chart-container">
          <h3>Gain / Loss by Asset</h3>
          <canvas id="gainloss-chart"></canvas>
        </div>
        <div class="chart-container">
          <h3>Asset Type Allocation</h3>
          <canvas id="asset-type-chart"></canvas>
        </div>
      </div>

      <!-- Allocation Breakdown -->
      <div class="chart-container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <h3 style="margin-bottom: 0;">Allocation Breakdown</h3>
          <div class="radio-group" id="allocation-selector">
            <label>
              <input type="radio" name="allocation-view" value="industry" checked>
              <span>Industry</span>
            </label>
            <label>
              <input type="radio" name="allocation-view" value="geography">
              <span>Geography</span>
            </label>
            <label>
              <input type="radio" name="allocation-view" value="fund">
              <span>Fund</span>
            </label>
          </div>
        </div>
        <div id="allocation-empty" class="hidden" style="text-align: center; padding: 24px; color: var(--text-muted);">
          No allocation data found. Add entries to the Investment Allocations database in Notion.
        </div>
        <canvas id="allocation-chart"></canvas>
      </div>

      <!-- Portfolio Value Over Time -->
      <div class="chart-container">
        <h3>Portfolio Value Over Time</h3>
        <canvas id="value-history-chart"></canvas>
      </div>
    </div>

    <!-- Projections Section -->
    <div id="projections-section" class="hidden">
      <div class="chart-container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
          <h3 style="margin-bottom: 0;">5-Year Portfolio Projection</h3>
          <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
            <div class="range-control">
              <label for="growth-rate-slider">Annual Growth</label>
              <div class="range-wrapper">
                <input type="range" id="growth-rate-slider" min="0" max="20" step="0.5" value="7">
                <span class="range-value" id="growth-rate-value">7.0%</span>
              </div>
            </div>
            <label class="toggle-label">
              <input type="checkbox" id="include-unvested" checked>
              <span>Include unvested</span>
            </label>
          </div>
        </div>
        <canvas id="projection-chart"></canvas>
      </div>

      <!-- Projection Summary Table -->
      <div class="card">
        <h3 class="card-title">Projection Summary</h3>
        <div class="table-container">
          <table id="projection-table">
            <thead>
              <tr>
                <th>Year</th>
                <th style="text-align: right;">Q1</th>
                <th style="text-align: right;">Q2</th>
                <th style="text-align: right;">Q3</th>
                <th style="text-align: right;">Q4</th>
                <th style="text-align: right;">Year-End</th>
                <th style="text-align: right;">YoY Growth</th>
              </tr>
            </thead>
            <tbody id="projection-table-body">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="card hidden">
      <div style="text-align: center; padding: 40px;">
        <div style="color: var(--text-muted); margin-bottom: 16px;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
            <polyline points="16 7 22 7 22 13"></polyline>
          </svg>
        </div>
        <p style="margin-top: 15px; color: var(--text-secondary);">No investments found.</p>
        <p style="color: var(--text-muted);">Add investments to your Notion database to see them here.</p>
      </div>
    </div>
  </main>

  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/investments.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (!Auth.requireAuth()) return;
      Auth.initLogoutButton();
      Investments.init();
    });
  </script>
</body>
</html>
